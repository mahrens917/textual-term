# =============================================================================
# Shared Tool Configuration for CI Pipeline
# =============================================================================
#
# This file contains standardized tool configurations used across ALL repositories
# (zeus, kalshi, aws, ci_shared) to ensure consistent CI behavior.
#
# WHY THIS EXISTS:
#   - Each repo has its own pyproject.toml with repo-specific metadata/dependencies
#   - However, tool configurations (ruff, bandit, pytest, etc.) should be identical
#   - This file is the single source of truth for [tool.*] sections
#
# CONSUMING REPOSITORIES (zeus, kalshi, aws):
#
# 1. Initial Setup - Copy tool configs to your pyproject.toml:
#      cd /path/to/your/repo
#      python -m ci_tools.scripts.tool_config_guard --sync
#
# 2. Validation - Check if your configs match:
#      python -m ci_tools.scripts.tool_config_guard
#
# 3. Keep in Sync - When this file is updated, re-run sync:
#      python -m ci_tools.scripts.tool_config_guard --sync
#
# NOTES:
#   - Only [tool.*] sections are standardized
#   - Project metadata ([project], [build-system]) remains repo-specific
#   - Dependencies remain repo-specific
#   - The guard validates but doesn't auto-modify (prevents corruption)
#
# =============================================================================
#
# NOTE: [tool.deptry] is intentionally EXCLUDED because each repository has
# different dependencies, package structures, and ignore rules. Deptry configs
# should remain repository-specific.
# =============================================================================

[tool.pytest.ini_options]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "session"
asyncio_default_test_loop_scope = "session"
addopts = [
    "-q",
    "--tb=no",
    "--strict-markers",
    "--strict-config",
    "--durations=10",
    "--durations-min=0.1",
    "-rEw",
    "-p",
    "pytest_asyncio",
    "-p",
    "no:jaxtyping",
]
testpaths = ["tests"]
pythonpath = ["src"]
consider_namespace_packages = true
norecursedirs = ["tests/manual"]
env = [
    "PYTHONDONTWRITEBYTECODE=1",
    "REDIS_HOST=localhost",
    "REDIS_PORT=6379",
    "REDIS_DB=0",
    "REDIS_PASSWORD=",
    "REDIS_SSL=false",
    "REDIS_RETRY_ON_TIMEOUT=false",
    "REDIS_SOCKET_TIMEOUT=30",
    "REDIS_SOCKET_CONNECT_TIMEOUT=30",
]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
timeout = 30
timeout_method = "thread"
markers = [
    "unit: Unit tests - fast, isolated tests (< 1 second each)",
    "integration: Integration tests - test component interactions (< 15 seconds each)",
    "e2e: End-to-end tests - full system tests (< 2 minutes each)",
    "slow: Tests that take longer to run (> 1 second)",
    "fast: Fast running tests (< 1 second)",
    "pdf: PDF processing related tests",
    "redis: Tests requiring Redis connection",
    "external: Tests requiring external services",
    "performance: Performance-critical tests with timing requirements",
    "parallel_safe: Tests explicitly verified safe for parallel execution (unused in sequential mode)",
    "sequential_only: Tests that must run sequentially (now default behavior)",
    "cache_population: Tests that populate cache for other tests (run first)",
    "multi_currency: Tests that use both BTC and ETH data",
    "btc_specific: Tests specific to BTC currency",
    "eth_specific: Tests specific to ETH currency",
    "cache_dependent: Tests that benefit from populated cache (run after cache population)",
    "pnl: PnL (Profit and Loss) system related tests",
    "slowpdf: Deterministic PDF performance regression tests",
]
junit_family = "xunit2"
junit_duration_report = "total"
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
    "ignore:The optimal value found.*is close to the specified.*bound.*:UserWarning",
    "ignore::pytest.PytestUnraisableExceptionWarning",
    "ignore::ResourceWarning",
    "ignore::UserWarning:sklearn",
    "ignore::FutureWarning:sklearn",
    "ignore::FutureWarning",
]

[tool.coverage.run]
# Exclude test code from coverage - we only measure production code
omit = [
    "*/vendor/*",
    "*/__main__.py",
    "**/__init__.py",    # Skip package initializers
    "tests/*",           # Exclude test directory
    "*/tests/*",         # Exclude tests in any subdirectory
    "*_test_*.py",       # Exclude test utility files (e.g., api_test_utils.py)
    "*/dependency_injector/*.pyx",    # Exclude Cython files that can't be parsed
    "*/dependency_injector/**/*.pyx", # Exclude all nested Cython files
    "*/site-packages/*", # Exclude all third-party packages
    "*helpers/__init__.py",    # Exclude helper module re-exports (only contain imports)
    "*/_module_references.py", # Exclude module reference files (prevent circular imports)
    "*/_path_init.py",   # Exclude path initialization modules (side-effect imports at load time)
    "*/ui.py",           # Exclude UI entrypoint scripts
    "*/ui_core/**/*.py",  # Exclude ui_core subsystem (hard to unit test)
    "*/textual_ui/**/*.py",  # Exclude textual_ui TUI subsystem (hard to unit test)
    "src/web.py",        # Exclude web entrypoint script
    "*/web/routes/*.py", # Exclude FastAPI routes (integration-tested, not unit-tested)
    "*/web/services/data_provider.py",  # Exclude web data provider (integration-tested)
    "*/web/services/rich_renderer_helpers/*.py",  # Exclude Rich HTML renderers (hard to unit test)
    "*/simple_monitor_components/bootstrap.py",  # Exclude bootstrap wiring (complex DI, integration-tested)
    "*/simple_monitor_setup/services.py",  # Exclude service wiring (complex DI, integration-tested)
    "*/price_alert/service_helpers/runner.py",  # Exclude price alert runner (async runtime loop, integration-tested)
    "*/price_alert/service_helpers/currency_monitor.py",  # Exclude currency monitor (async runtime loop, integration-tested)
    "scripts/**",  # Exclude CLI scripts and infrastructure code (not unit-testable)
]

[tool.coverage.report]
# Also exclude these from report output (run.omit excludes from collection,
# report.omit excludes from display - both needed for complete exclusion)
omit = [
    "**/__init__.py",    # Skip package initializers
    "*helpers/__init__.py",    # Exclude helper module re-exports (only contain imports)
    "*/_module_references.py", # Exclude module reference files (prevent circular imports)
    "*/_path_init.py",   # Exclude path initialization modules (side-effect imports at load time)
    "*/ui.py",           # Exclude UI entrypoint scripts
    "*/ui_core/**/*.py",  # Exclude ui_core subsystem (hard to unit test)
    "*/textual_ui/**/*.py",  # Exclude textual_ui TUI subsystem (hard to unit test)
    "src/web.py",        # Exclude web entrypoint script
    "*/web/routes/*.py", # Exclude FastAPI routes (integration-tested, not unit-tested)
    "*/web/services/data_provider.py",  # Exclude web data provider (integration-tested)
    "*/web/services/rich_renderer_helpers/*.py",  # Exclude Rich HTML renderers (hard to unit test)
    "*/simple_monitor_components/bootstrap.py",  # Exclude bootstrap wiring (complex DI, integration-tested)
    "*/simple_monitor_setup/services.py",  # Exclude service wiring (complex DI, integration-tested)
    "*/price_alert/service_helpers/runner.py",  # Exclude price alert runner (async runtime loop, integration-tested)
    "*/price_alert/service_helpers/currency_monitor.py",  # Exclude currency monitor (async runtime loop, integration-tested)
    "scripts/**",  # Exclude CLI scripts and infrastructure code (not unit-testable)
]

[tool.bandit]
# Skip checks that are expected/acceptable in our codebase
skips = [
    "B101",  # assert_used - used appropriately in tests
    "B301",  # pickle - trusted-only serialization helpers
    "B403",  # import_pickle - trusted-only serialization helpers
    "B105",  # hardcoded_password_string - test fixtures deliberately use literals
    "B106",  # hardcoded_password_funcarg - test fixtures deliberately use literals
    "B107",  # hardcoded_password_default - NOAA sentinel tokens flagged as passwords
    "B108",  # hardcoded_tmp_directory - acceptable in test fixtures
    "B110",  # try_except_pass - intentional cleanup guards suppress noisy logs
    "B311",  # random - standard RNG acceptable for jitter/data sampling
    "B404",  # import_subprocess - required for CI automation
    "B603",  # subprocess_without_shell_equals_true - our subprocess calls are safe
    "B607",  # start_process_with_partial_path - standard system commands (git, etc.)
    "B608",  # hardcoded_sql_expressions - false positive with internal field names
]
exclude_dirs = ["/vendor/", "/.venv/", "/venv/", "/artifacts/", "/trash/", "/models/", "/logs/", "/data/"]

[tool.ruff]
extend-exclude = ["ci_tools/vendor", "scripts/_AUTOGENERATED*", "scripts/_ensemble_train_modal.py"]

[tool.ruff.lint]
select = ["TRY", "C90", "PLR"]  # C90=McCabe complexity, PLR=Pylint refactor
ignore = ["TRY003"]  # Allow long exception messages

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.pylint]
max-args = 7
max-branches = 10
max-statements = 50

[tool.ruff.lint.per-file-ignores]
"tests/**" = ["TRY002", "TRY203", "PLR2004"]

[tool.pylint.MAIN]
init-hook = "import sys; sys.path.insert(0, 'src'); sys.path.insert(0, 'tests')"

[tool.pylint.format]
# Match black's line length setting
max-line-length = 140

[tool.pylint.BASIC]
# Allow ast.NodeVisitor method naming pattern (visit_Name, visit_If, etc.)
method-rgx = "([a-z_][a-z0-9_]*|visit_[A-Z][A-Za-z]*)"

[tool.pylint."messages_control"]
# Protocol classes are type stubs that don't need public methods
# Additional rules disabled for code patterns acceptable in our codebase
disable = [
    "too-few-public-methods",
    "import-outside-toplevel",
    "protected-access",
    "unused-argument",
    "unnecessary-ellipsis",
    "try-except-raise",
    "broad-exception-caught",
    "missing-function-docstring",
    "missing-class-docstring",
    "missing-module-docstring",
    "wrong-import-position",
    "duplicate-code",
    "cyclic-import",
    "too-many-instance-attributes",
    "no-member",
    "redefined-outer-name",
    "too-many-locals",
    "pointless-string-statement",
    "abstract-method",
    "no-name-in-module",
    "invalid-name",
    "no-else-raise",
    "no-else-return",
    "unnecessary-lambda",
    "raise-missing-from",
    "line-too-long",
    "implicit-str-concat",
    "unused-variable",
    "unused-import",
    "not-callable",
    "too-many-lines",
    "use-implicit-booleaness-not-comparison",
    "use-maxsplit-arg",
    "using-constant-test",
    "wrong-import-order",
    "assignment-from-no-return",
    "no-value-for-parameter",
    "invalid-overridden-method",
    "global-statement",
    "redefined-builtin",
]

[tool.pylint.SIMILARITIES]
min-similarity-lines = 7

[tool.pylint.design]
max-args = 8
max-positional-arguments = 8
max-attributes = 8

[tool.pyright]
typeCheckingMode = "basic"
pythonVersion = "3.12"
reportMissingImports = "error"
reportMissingTypeStubs = "none"
reportUnusedImport = "error"
reportUnusedVariable = "error"
reportDuplicateImport = "error"
reportPrivateUsage = "none"
reportUnnecessaryIsInstance = "warning"
reportUnnecessaryCast = "warning"
reportUnnecessaryComparison = "warning"
reportAssertAlwaysTrue = "warning"
reportSelfClsParameterName = "warning"
reportImplicitStringConcatenation = "none"
reportInvalidStubStatement = "warning"
reportIncompleteStub = "none"
reportUndefinedVariable = "error"
reportUnboundVariable = "error"
reportOptionalSubscript = "warning"
reportOptionalMemberAccess = "warning"
reportOptionalCall = "warning"
reportOptionalIterable = "warning"
reportOptionalContextManager = "warning"
reportOptionalOperand = "warning"
reportUntypedFunctionDecorator = "none"
reportUntypedClassDecorator = "none"
reportUntypedBaseClass = "none"
reportUntypedNamedTuple = "warning"
reportCallInDefaultInitializer = "none"
reportUninitializedInstanceVariable = "none"
reportInvalidTypeVarUse = "warning"
reportPropertyTypeMismatch = "warning"
reportFunctionMemberAccess = "warning"
reportGeneralTypeIssues = "error"
reportMissingModuleSource = "none"
reportAttributeAccessIssue = "warning"
reportArgumentType = "warning"
reportCallIssue = "warning"
reportReturnType = "warning"
reportAssignmentType = "warning"
reportIndexIssue = "warning"
reportOperatorIssue = "warning"
